#!/usr/bin/env python
import subprocess
import os
import signal



import types
import sys
import base64
utils_module=types.ModuleType("utils")
#setattr(utils_module,"__file__",__file__)
exec(base64.b64decode(b'aW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHJlCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgb3MKaW1wb3J0IHBhdGhsaWIKaW1wb3J0IHNpZ25hbCAKaW1wb3J0IHRpbWUKaW1wb3J0IHN5cwppbXBvcnQgdHlwaW5nCmltcG9ydCBzaHV0aWwKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgY29udGV4dGxpYgoKZm9yIHZhciBpbiBbIlJPT1QiLCJHTE9CQUxTIiwiQ0xBU1MiXToKICAgIGdsb2JhbHMoKVt2YXJdPU5vbmUKICAgIApkZWYgZ2V0X3RlbXBkaXIoKToKICAgIGlmIG9zLnVuYW1lKCkuc3lzbmFtZT09IkRhcndpbiI6CiAgICAgICAgcmV0dXJuICIvdG1wIgogICAgZWxzZToKICAgICAgICByZXR1cm4gdGVtcGZpbGUuZ2V0dGVtcGRpcigpCiAgICAKVEVNUERJUj1nZXRfdGVtcGRpcigpCgoKY2xhc3MgRG9lc05vdEV4aXN0KEV4Y2VwdGlvbik6CiAgICBwYXNzCgpkZWYgZ2V0X3ZhbHVlKHZhcmlhYmxlLGRlZmF1bHQpOgoJaWYgbm90IHZhcmlhYmxlOgoJCXJldHVybiBkZWZhdWx0CgllbHNlOgoJCXJldHVybiB2YXJpYWJsZQoKZGVmIGdldF9yb290X2RpcmVjdG9yeShyb290X3ZhcmlhYmxlPU5vbmUsZGVmYXVsdF92YWx1ZT1Ob25lKToKICAgIHJvb3RfdmFyaWFibGU9Z2V0X3ZhbHVlKHJvb3RfdmFyaWFibGUsZiJ7Q0xBU1MuX19uYW1lX18udXBwZXIoKX1fUk9PVCIpCiAgICBkZWZhdWx0X3ZhbHVlPWdldF92YWx1ZShkZWZhdWx0X3ZhbHVlLGYie29zLmVudmlyb25bJ0hPTUUnXX0ve0NMQVNTLl9fbmFtZV9fLnRpdGxlKCl9cyIpCiAgICByZXR1cm4gb3MucGF0aC5leHBhbmR1c2VyKG9zLmdldGVudihyb290X3ZhcmlhYmxlLGRlZmF1bHRfdmFsdWUpKQoKIAogICAgCiNST09UPU5vbmUKI05BTUVTPU5vbmUKI0ZMQUdTPU5vbmUKI0ZVTkNUSU9OPU5vbmUKI1RFTVBESVI9Tm9uZQoKZGVmIGxpc3RfaXRlbXNfaW5fcm9vdChuYW1lcyxmbGFncyk6CiAgICBBbGw9W18gZm9yIF8gaW4gc29ydGVkKG9zLmxpc3RkaXIoUk9PVCkpIGlmIG5vdCBfLnN0YXJ0c3dpdGgoJy4nKSBdCiAgICAKICAgIGZvciBmbGFnIGluIFsic3RhcnRlZCIsInN0b3BwZWQiLCJlbmFibGVkIiwiZGlzYWJsZWQiXToKICAgICAgICBpZiAiLS0iK2ZsYWcgaW4gZmxhZ3M6CiAgICAgICAgICAgIG5hbWVzKz1bXyBmb3IgXyBpbiBBbGwgaWYgZmxhZy50aXRsZSgpIGluIENMQVNTKF8pLlN0YXR1cygpIF0KICAgICAgICAgICAgZmxhZ3MucmVtb3ZlKCItLSIrZmxhZykKCiAgICBpZiAiLS1hbGwiIGluIGZsYWdzOgogICAgICAgIG5hbWVzKz1BbGwKICAgICAgICBmbGFncy5yZW1vdmUoIi0tYWxsIikKICAgIGlmIG5hbWVzPT1bXToKICAgICAgICBwcmludChmIk5vIHtDTEFTUy5fX05BTUVfXy5sb3dlcigpfXMgc3BlY2lmaWVkISIpCiAgICAgICAgZXhpdCgpCiAgICByZXR1cm4gbmFtZXMKCmRlZiBmbGF0dGVuX2xpc3QoaXRlbXMpOgogICAgIiIiWWllbGQgaXRlbXMgZnJvbSBhbnkgbmVzdGVkIGl0ZXJhYmxlLiIiIgogICAgZm9yIHggaW4gaXRlbXM6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh4LCB0eXBpbmcuSXRlcmFibGUpIGFuZCBub3QgaXNpbnN0YW5jZSh4LCAoc3RyLCBieXRlcykpOgogICAgICAgICAgICBmb3Igc3ViX3ggaW4gZmxhdHRlbl9saXN0KHgpOgogICAgICAgICAgICAgICAgeWllbGQgc3ViX3gKICAgICAgICBlbHNlOgogICAgICAgICAgICB5aWVsZCB4CgpkZWYgcHJpbnRfbGlzdChsKToKICAgIGZvciBlbGVtZW50IGluIGw6CiAgICAgICAgaWYgZWxlbWVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChlbmQ9JycpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoZWxlbWVudCkKCmRlZiBzcGxpdF9zdHJpbmdfYnlfY2hhcihzdHJpbmcsY2hhcj0nOicpOgogICAgUEFUVEVSTiA9IHJlLmNvbXBpbGUocmYnJycoKD86W15ce2NoYXJ9IiddfCJbXiJdKiJ8J1teJ10qJykrKScnJykKICAgIHJldHVybiBbXyBmb3IgXyBpbiBsaXN0KFBBVFRFUk4uc3BsaXQoc3RyaW5nKSkgaWYgXyBub3QgaW4gWycnLCBjaGFyXV0KCgpkZWYgc2hlbGxfY29tbWFuZChjb21tYW5kLHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsc3RkZXJyPXN1YnByb2Nlc3MuU1RET1VULGFyYml0cmFyeT1GYWxzZSxibG9jaz1UcnVlLGVudj1Ob25lKToKICAgIHByb2Nlc3MgPSBzdWJwcm9jZXNzLlBvcGVuKGNvbW1hbmQsIHN0ZG91dD1zdGRvdXQsIHN0ZGVycj1zdGRlcnIsdW5pdmVyc2FsX25ld2xpbmVzPVRydWUsc2hlbGw9YXJiaXRyYXJ5LGVudj1lbnYpCiAgICBpZiBibG9jazoKICAgICAgICByZXR1cm4gcHJvY2Vzcy5jb21tdW5pY2F0ZSgpWzBdCgpkZWYgd2FpdF91bnRpbF9waWRfZXhpdHMocGlkKToKICAgIAogICAgZGVmIHBpZF9leGlzdHMocGlkKTogICAKICAgICAgICAiIiIgQ2hlY2sgRm9yIHRoZSBleGlzdGVuY2Ugb2YgYSB1bml4IHBpZC4gIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcy5raWxsKHBpZCwgMCkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICB3aGlsZSBwaWRfZXhpc3RzKHBpZCk6CiAgICAgICAgdGltZS5zbGVlcCgwLjI1KQogICAgICAgIApkZWYga2lsbF9wcm9jZXNzX2dyYWNlZnVsbHkocGlkKToKICAgIAogICAgdHJ5OgogICAgICAgIG9zLmtpbGwocGlkLHNpZ25hbC5TSUdURVJNKQogICAgICAgIHRyeToKICAgICAgICAgICAgb3Mud2FpdHBpZChwaWQsMCkKICAgICAgICBleGNlcHQgQ2hpbGRQcm9jZXNzRXJyb3I6ICNOb3QgYSBjaGlsZCBwcm9jZXNzIHNvIG1vdmUgb24KICAgICAgICAgICAgcGFzcwogICAgICAgIHdhaXRfdW50aWxfcGlkX2V4aXRzKHBpZCkKICAgIGV4Y2VwdCBQcm9jZXNzTG9va3VwRXJyb3I6CiAgICAgICAgcGFzcwogICAgCmRlZiBleHRyYWN0X2FyZ3VtZW50cygpOgogICAgYXJndW1lbnRzPXN5cy5hcmd2WzE6XQogICAgdHJ5OgogICAgICAgIEZVTkNUSU9OPWFyZ3VtZW50c1swXQogICAgZXhjZXB0IEluZGV4RXJyb3I6CiAgICAgICAgcHJpbnQoIk5vIGZ1bmN0aW9uIHNwZWNpZmllZCEiKQogICAgICAgIGV4aXQoKQogICAgYXJndW1lbnRzPWFyZ3VtZW50c1sxOl0KICAgIAogICAgTkFNRVM9W10KICAgIEZMQUdTPWFyZ3VtZW50cwogICAgZm9yIGkgaW4gcmFuZ2UobGVuKGFyZ3VtZW50cykpOgogICAgICAgIGlmIG5vdCBhcmd1bWVudHNbaV0uc3RhcnRzd2l0aCgiLS0iKToKICAgICAgICAgICAgRkxBR1M9YXJndW1lbnRzWzppXQogICAgICAgICAgICBOQU1FUz1hcmd1bWVudHNbaTpdCiAgICAgICAgICAgIGJyZWFrCiAgICByZXR1cm4gKE5BTUVTLEZMQUdTLEZVTkNUSU9OKQoKZGVmIGFkZF9lbnZpcm9ubWVudF92YXJpYWJsZV90b19zdHJpbmcoc3RyaW5nLGVudl92YXIpOgogICAgcmV0dXJuIHN0cmluZytmIjsgZXhwb3J0IHtlbnZfdmFyfSIKCmRlZiB3YWl0KGRlbGF5PU5vbmUpOgogICAgdGhyZWFkaW5nLkV2ZW50KCkud2FpdCh0aW1lb3V0PWRlbGF5KQoKZGVmIGV4ZWN1dGVfY2xhc3NfbWV0aG9kKGNsYXNzX2luc3RhbmNlLGZ1bmN0aW9uKToKICAgIGlmIG5vdCBjYWxsYWJsZShnZXRhdHRyKGNsYXNzX2luc3RhbmNlLCBmdW5jdGlvbi50aXRsZSgpLE5vbmUpKToKICAgICAgICAgICAgcHJpbnQoZiJDb21tYW5kIHtmdW5jdGlvbn0gZG9lc24ndCBleGlzdCEiKQogICAgICAgICAgICBleGl0KCkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGxpc3QoZmxhdHRlbl9saXN0KFtnZXRhdHRyKGNsYXNzX2luc3RhbmNlLGZ1bmN0aW9uLnRpdGxlKCkpKCldKSkKCmRlZiBjaGVja19pZl9lbGVtZW50X2FueV9pc19pbl9saXN0KGVsZW1lbnRzLF9saXN0KToKICAgIHJldHVybiBhbnkoXyBpbiBfbGlzdCBmb3IgXyBpbiBlbGVtZW50cykKICAgIApkZWYgZXhwb3J0X21ldGhvZHNfZnJvbV9zZWxmKHNlbGYpOgogICAgbWV0aG9kcz17fQogICAgZm9yIGZ1bmMgaW4gW2Z1bmMgZm9yIGZ1bmMgaW4gZGlyKHNlbGYpIGlmIGNhbGxhYmxlKGdldGF0dHIoc2VsZiwgZnVuYykpIGFuZCBub3QgZnVuYy5zdGFydHN3aXRoKCdfXycpXToKICAgICAgICBtZXRob2RzW2Z1bmNdPWdldGF0dHIoc2VsZixmdW5jKQogICAgCiAgICByZXR1cm4gbWV0aG9kcwpkZWYgd3JhcF9hbGxfbWV0aG9kc19pbl9jbGFzc193aXRoX2NoZGlyX2NvbnRleHRtYW5hZ2VyKHNlbGYscGF0aCk6CiAgICBAY29udGV4dGxpYi5jb250ZXh0bWFuYWdlcgogICAgZGVmIHNldF9kaXJlY3RvcnkocGF0aCk6CiAgICAgICAgIiIiU2V0cyB0aGUgY3dkIHdpdGhpbiB0aGUgY29udGV4dAogICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcGF0aCAoUGF0aCk6IFRoZSBwYXRoIHRvIHRoZSBjd2QKICAgIAogICAgICAgIFlpZWxkczoKICAgICAgICAgICAgTm9uZQogICAgICAgICIiIgogICAgCiAgICAgICAgb3JpZ2luID0gb3MucGF0aC5hYnNwYXRoKG9zLmdldGN3ZCgpKQogICAgICAgIHRyeToKICAgICAgICAgICAgb3MuY2hkaXIocGF0aCkKICAgICAgICAgICAgeWllbGQKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgb3MuY2hkaXIob3JpZ2luKQogICAgCiAgICBkZWYgd3JhcHBlcihmdW5jKToKICAgICAgICBkZWYgbmV3X2Z1bmMoKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgd2l0aCBzZXRfZGlyZWN0b3J5KHBhdGgpOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIHJldHVybiBuZXdfZnVuYwogICAgICAgICAgICAKICAgIGZvciBmdW5jIGluIFtmdW5jIGZvciBmdW5jIGluIGRpcihzZWxmKSBpZiBjYWxsYWJsZShnZXRhdHRyKHNlbGYsIGZ1bmMpKSBhbmQgbm90IGZ1bmMuc3RhcnRzd2l0aCgnX18nKV06CiAgICAgICAgc2V0YXR0cihzZWxmLGZ1bmMsd3JhcHBlcihnZXRhdHRyKHNlbGYsZnVuYykpKQpjbGFzcyBDbGFzczoKICAgIGRlZiBfX2luaXRfXyhzZWxmLGNsYXNzX3NlbGYpOgogICAgICAgIHNlbGYuc2VsZj1jbGFzc19zZWxmCiAgICAgICAgc2VsZi5uYW1lPUNMQVNTLl9fbmFtZV9fCiAgICAKICAgIGRlZiBjbGFzc19pbml0KHNlbGYsX25hbWUsX2ZsYWdzLF9mdW5jdGlvbixfd29ya2Rpcik6CiAgICAgICAgc2VsZi5zZWxmLm5hbWU9X25hbWUKICAgICAgICAKICAgICAgICBzZWxmLnNlbGYuZmxhZ3M9Z2V0X3ZhbHVlKF9mbGFncyxbXSkKICAgICAgICAKICAgICAgICBzZWxmLnNlbGYuZnVuY3Rpb249Z2V0X3ZhbHVlKF9mdW5jdGlvbiwiIikKICAgICAgICAKICAgICAgICBpZiBzZWxmLnNlbGYuZnVuY3Rpb24gbm90IGluIFsiaW5pdCJdOgogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2RpcihmIntST09UfS97c2VsZi5zZWxmLm5hbWV9Iik6CiAgICAgICAgICAgICAgICAgcmFpc2UgRG9lc05vdEV4aXN0KCkKICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgd3JhcF9hbGxfbWV0aG9kc19pbl9jbGFzc193aXRoX2NoZGlyX2NvbnRleHRtYW5hZ2VyKHNlbGYuc2VsZixmIntST09UfS97c2VsZi5zZWxmLm5hbWV9IikKICAgICAgICBzZWxmLnNlbGYud29ya2Rpcj1fd29ya2RpcgogICAgICAgIAogICAgICAgIHNlbGYuc2VsZi5nbG9iYWxzPUdMT0JBTFMuY29weSgpCiAgICAgICAgc2VsZi5zZWxmLmdsb2JhbHMudXBkYXRlKGV4cG9ydF9tZXRob2RzX2Zyb21fc2VsZihzZWxmLnNlbGYpKQogICAgICAgIAogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgaWYgIlN0b3BwZWQiIGluIHNlbGYuc2VsZi5TdGF0dXMoKToKICAgICAgICAgICAgcmV0dXJuIGYie3NlbGYubmFtZX0ge3NlbGYuc2VsZi5uYW1lfSBpcyBhbHJlYWR5IHN0b3BwZWQiCiAgICAgICAgCiAgICAgICAgZm9yIHBpZCBpbiBzZWxmLnNlbGYuUHMoIm1haW4iKToKICAgICAgICAgICAga2lsbF9wcm9jZXNzX2dyYWNlZnVsbHkocGlkKQogICAgICAgIAogICAgICAgIGZvciBlbmRpbmcgaW4gWyJsb2ciLCJsb2NrIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgb3MucmVtb3ZlKGYie1RFTVBESVJ9L3tzZWxmLm5hbWUubG93ZXIoKX1fe3NlbGYuc2VsZi5uYW1lfS57ZW5kaW5nfSIpCiAgICAgICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgcmVzdGFydChzZWxmKToKICAgICAgICByZXR1cm4gW3NlbGYuc2VsZi5TdG9wKCksc2VsZi5zZWxmLlN0YXJ0KCldCiAgICAKICAgIGRlZiBnZXRfbWFpbl9wcm9jZXNzKHNlbGYpOgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShmIntURU1QRElSfS97c2VsZi5uYW1lLmxvd2VyKCl9X3tzZWxmLnNlbGYubmFtZX0ubG9jayIpOgogICAgICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGxpc3QobWFwKGludCxbX1sxOl0gZm9yIF8gaW4gc2hlbGxfY29tbWFuZChbImxzb2YiLCItRnAiLCItdyIsZiJ7VEVNUERJUn0ve3NlbGYubmFtZS5sb3dlcigpfV97c2VsZi5zZWxmLm5hbWV9LmxvY2siXSkuc3BsaXRsaW5lcygpXSkpCiAgICAKICAgIGRlZiBsaXN0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnNlbGYubmFtZQogICAgICAgIAogICAgZGVmIHdvcmtkaXIoc2VsZix3b3JrX2Rpcik6CiAgICAgICAgI1JlbW92ZSB0cmFpbGluZyBzbGFzaGVzLCBidXQgb25seSBmb3Igc3RyaW5ncyB0aGF0IGFyZSBub3QgLwogICAgICAgIGlmIHdvcmtfZGlyLmVuZHN3aXRoKCcvJykgYW5kIGxlbih3b3JrX2Rpcik+MToKICAgICAgICAgICAgd29ya19kaXI9d29ya19kaXJbOi0xXQogICAgICAgICAgICAKICAgICAgICBpZiB3b3JrX2Rpci5zdGFydHN3aXRoKCIvIik6CiAgICAgICAgICAgIHNlbGYuc2VsZi53b3JrZGlyPXdvcmtfZGlyCiAgICAgICAgZWxzZTogICAgCiAgICAgICAgICAgIHNlbGYuc2VsZi53b3JrZGlyKz0nLycrd29ya19kaXIKICAgICAgICAKICAgICAgICAjUmVtb3ZlIHJlcGVhdGVkIC8gaW4gd29ya2RpcgogICAgICAgIHNlbGYuc2VsZi53b3JrZGlyPXJlLnN1YihyJygvKVwxKycsIHInXDEnLHNlbGYuc2VsZi53b3JrZGlyKQoKICAgIGRlZiBzdGF0dXMoc2VsZik6CiAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoZiJ7VEVNUERJUn0ve3NlbGYubmFtZS5sb3dlcigpfV97c2VsZi5zZWxmLm5hbWV9LmxvZyIpOgogICAgICAgICAgICByZXR1cm4gWyJTdGFydGVkIl0KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gWyJTdG9wcGVkIl0KCiAgICBkZWYgbG9vcChzZWxmLGNvbW1hbmQsZGVsYXk9NjApOgogICAgICAgIGlmIGlzaW5zdGFuY2UoY29tbWFuZCxzdHIpOgogICAgICAgICAgICBkZWYgZnVuYygpOgogICAgICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbGYuUnVuKGNvbW1hbmQpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZWxmLldhaXQoZGVsYXkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGVmIGZ1bmMoKToKICAgICAgICAgICAgICAgIHdoaWxlIFRydWU6ICAKICAgICAgICAgICAgICAgICAgICBjb21tYW5kKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbGYuV2FpdChkZWxheSkKICAgICAgICBzZWxmLnNlbGYuUnVuKCIiKSAjTmVlZGVkIHRvIGF2b2lkIHJhY2UgY29uZGl0aW9ucyB3aXRoIGEgcmFjZSB0aGF0J3MgcmlnaHQgYWZ0ZXIgLS0tIGp1c3QgcnVuIHNlbGYuc2VsZi5SdW4gb25jZQogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PWZ1bmMsZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgIAoKICAgIGRlZiBsb2coc2VsZik6CiAgICAgICAgc2hlbGxfY29tbWFuZChbImxlc3MiLCIrRyIsIi1mIiwiLXIiLGYie1RFTVBESVJ9L3tzZWxmLm5hbWUubG93ZXIoKX1fe3NlbGYuc2VsZi5uYW1lfS5sb2ciXSxzdGRvdXQ9Tm9uZSkKICAgIAogICAgZGVmIGRlbGV0ZShzZWxmKToKICAgICAgICBzZWxmLnNlbGYuU3RvcCgpCiAgICAgICAgc2h1dGlsLnJtdHJlZShmIntST09UfS97c2VsZi5zZWxmLm5hbWV9IikKICAgIAogICAgZGVmIHdhdGNoKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2hlbGxfY29tbWFuZChbInRhaWwiLCItZiIsIi0tZm9sbG93PW5hbWUiLGYie1RFTVBESVJ9L3tzZWxmLm5hbWUubG93ZXIoKX1fe3NlbGYuc2VsZi5uYW1lfS5sb2ciXSxzdGRvdXQ9Tm9uZSkKICAgICAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgICAgIHBhc3MKICAgIAoK').decode("utf-8"),utils_module.__dict__)
sys.modules["utils"]=utils_module
import utils


utils.GLOBALS=globals()


def flatten(*args, **kwargs):
    return utils.flatten_list(*args, **kwargs)

def print_result(*args, **kwargs):
    return utils.print_list(*args, **kwargs)

def split_by_char(*args, **kwargs):
    return utils.split_by_char(*args, **kwargs)

class Service:
    def __init__(self,_name,_flags=None,_function=None,_env=None,_workdir='.'):
        self.Class = utils.Class(self)
        self.Class.class_init(_name,_flags,_function,_workdir)
        
        self.env=utils.get_value(_env,f"export SERVICE_NAME={self.name}")
        
        self.temp_services=[]
        
        self.exit_cmds=[]

    #Functions to be used in *service.py
    def Run(self,command="",pipe=False,track=True):
        with open(f"{utils.TEMPDIR}/service_{self.name}.log","a+") as log_file:
            if track:
                log_file.write(f"Command: {command}\n")
                log_file.flush()

            #Pipe output to variable
            if pipe:
                stdout=subprocess.PIPE
                stderr=subprocess.DEVNULL
            #Print output to file
            else:
                stdout=log_file
                stderr=subprocess.STDOUT
            return utils.shell_command(f"{self.env if track else 'true'}; cd {self.workdir}; {command}",stdout=stdout,stderr=stderr,arbitrary=True)
    
    def Ps(self,process=None):
        
        #Find main process
        if process=="main" or ("--main" in self.flags):
            return self.Class.get_main_process()
            
        #Find processes running under main Start script
        elif process=="auxiliary" or ("--auxiliary" in self.flags):
            processes=utils.shell_command(["ps","auxwwe"]).splitlines()
            processes=[_.split()[1] for _ in processes if f"SERVICE_NAME={self.name}" in _]
            return list(map(int,processes))

    
    def Env(self,*args, **kwargs):
        self.env=utils.add_environment_variable_to_string(self.env,*args, **kwargs)
    
    def Container(self,_container=None):
        #Convience --- if conainer name is not specified, it will assume that the container is the same name as the service
        
        if not _container:
            _container=self.name
            
        self.Down(f"container stop {_container}")
        self.Run(f"container start {_container}",track=False)
        self.Run(f"echo Started container {_container}",track=False)
        
        with open(f"{utils.TEMPDIR}/service_{self.name}.log","a+") as f:
            utils.shell_command(["tail","-f","-n","+1",f"{utils.TEMPDIR}/container_{_container}.log"],stdout=f,block=False,env=os.environ.copy() | {"SERVICE_NAME":self.name})
        
        container_main_pid=utils.shell_command(["container","ps","--main",_container],stdout=subprocess.PIPE)
        
        #Wait until container ends
        try:
            container_main_pid=int(container_main_pid)
            utils.wait_until_pid_exits(container_main_pid)
        except ValueError:
            pass
    
    def Down(self,func):
        if isinstance(func,str):
            #So func won't be overwritten
            func_str=func
            def func():
                self.Run(func_str)
        self.exit_cmds.append(func)
        
    def Loop(self,*args, **kwargs):
        self.Class.loop(*args, **kwargs)
        #Run(f'(while true; do "{command}"; sleep {delay}; done)')

    def Wait(self,*args, **kwargs):
        utils.wait(*args, **kwargs)
    
    def Exit(self,signum,frame):
        for cmd in self.exit_cmds:
            cmd()
        for pid in self.Ps("auxiliary"):
            utils.kill_process_gracefully(pid)
        exit()
    
    def Dependency(self,service):
        if "Stopped" in self.__class__(service).Status():
            #self.temp_services.append(service)
            #Kill service when stopping
            self.Down(self.__class__(service).Stop)
            #utils.shell_command(["service","start",service],stdout=subprocess.DEVNULL)
            self.__class__(service).Start()
    #Commands      
    def Start(self):
        
        if "Started" in self.Status():
            return f"Service {self.name} is already started"
        
        #If child, run code, then exit 
        if os.fork()==0:
            signal.signal(signal.SIGTERM,self.Exit)
            
            if os.path.exists("data"):
                self.Workdir("data")
            
            if "Enabled" in self.Status():
                service_file="service.py"
            else:
                service_file=".service.py"
                
            #Open a lock file so I can find it with lsof later
            lock_file=open(f"{utils.TEMPDIR}/service_{self.name}.lock","w+")
            
            #Run *service.py
            with open(f"{ROOT}/{self.name}/{service_file}") as f:
                code=f.read()
            exec(code,self.globals,locals())
            
            #Don't exit script yet.
            self.Wait()
            exit()
       
    def Stop(self):
        return [self.Class.stop()]
        
    def Restart(self):
        return self.Class.restart()
    
    
    def List(self):
        return self.Class.list()
    
    def Workdir(self,work_dir):
        self.Class.workdir(work_dir)

    def Init(self):
        os.makedirs(f"{ROOT}/{self.name}",exist_ok=True)
        os.chdir(f"{ROOT}/{self.name}")
        os.makedirs("data",exist_ok=True)
        with open(f".service.py",'a'):
            pass
        
        if '--no-edit' not in self.flags:
            self.Edit()

    def Edit(self):
        if "Enabled" in self.Status():
            utils.shell_command([os.getenv("EDITOR","vi"),f"{ROOT}/{self.name}/service.py"],stdout=None)
        else:
            utils.shell_command([os.getenv("EDITOR","vi"),f"{ROOT}/{self.name}/.service.py"],stdout=None)
            
    def Status(self):
        return self.Class.status() + ["Enabled" if os.path.exists(f"{ROOT}/{self.name}/service.py") else "Disabled"]
    
    def Enable(self):
        if "Enabled" in self.Status():
            return [f"Service {self.name} is already enabled"]
        else:
            os.rename(f"{ROOT}/{self.name}/.service.py",f"{ROOT}/{self.name}/service.py")
        
        if '--now' in self.flags:
            return [self.Start()]

            
    def Disable(self):
        if "Disabled" in self.Status():
            return [f"Service {self.name} is already disabled"]
        else:
            os.rename(f"{ROOT}/{self.name}/service.py",f"{ROOT}/{self.name}/.service.py")
        
        if '--now' in self.flags:
            return [self.Stop()]

    def Log(self):
        self.Class.log()
    
    def Delete(self):
        self.Class.delete()
    
    def Watch(self):
        self.Class.watch()
utils.CLASS=Service
utils.ROOT=ROOT=utils.get_root_directory()
if __name__ == "__main__":
    
    NAMES,FLAGS,FUNCTION=utils.extract_arguments()
    
    for name in utils.list_items_in_root(NAMES, FLAGS):
        try:
            item=utils.CLASS(name,FLAGS,FUNCTION)
        except utils.DoesNotExist:
            print(f"Service {name} does not exist")
            continue
        
        result=utils.execute_class_method(item,FUNCTION)
        print_result(result)
        

    
