#!/bin/bash
ROOT=~/Services
NAME="${@: -1}"

if [ "$1" == "start" ]; then

	if [ "$2" == "--all" ]; then
		cd $ROOT
		for d in */; do 
			if [ -f "./$d" ]; then
				service start ${d::-1}
			fi
		done

		exit 1
	fi

	cd $ROOT/$NAME > /dev/null 2>&1
	eval "$(pdm --pep582)"

	if [ ! -f "./$NAME" ]; then
		if [ ! -f "./.$NAME" ]; then
			echo "Service $NAME does not exist"
			exit 1
		fi

		nohup ./.$NAME > /tmp/$NAME.log 2>&1 &
		touch /tmp/$NAME.log

		exit 1

		fi

	
	nohup ./$NAME > /tmp/$NAME.log 2>&1 &
	touch /tmp/$NAME.log

elif [ "$1" == "stop" ]; then
	PID=$(ps -ef | grep  "[.]/$NAME" | awk '{print $2}' | head -n1)

	if [ -z "${PID}" ]; then
		PID=$(ps -ef | grep  "[.]/.$NAME" | awk '{print $2}' | head -n1)

		if [ -z "${PID}" ]; then
			echo "Service $NAME is not running"
			rm -rf /tmp/$NAME.log
			exit 1
		fi
	fi
	kill $(pstree $PID -p -a -l | cut -d, -f2 | cut -d' ' -f1)  > /dev/null 2>&1&
	rm -rf /tmp/$NAME.log

elif [ "$1" == "log" ]; then
	EDITOR=$EDITOR less +G /tmp/$NAME.log

elif [ "$1" == "status" ]; then
	if [ -f "/tmp/$NAME.log" ]; then
    	echo "Started"
	else 
    	echo "Stopped"
    fi

    if [ -f "$ROOT/$NAME/$NAME" ]; then
    	echo "Enabled"
	else 
    	echo "Disabled"
    fi

elif [ "$1" == "disable" ]; then

	if [ ! -f $ROOT/$NAME/$NAME ]; then
	
		if [ ! -f $ROOT/$NAME/.$NAME ]; then
		
			echo "Service $NAME does not exist"
			exit 1
		fi
		echo "Service $NAME is not enabled"
		exit 1
	fi
	
	mv $ROOT/$NAME/$NAME $ROOT/$NAME/.$NAME

	if [ "$2" == "--now" ]; then
		service stop $NAME
	fi

elif [ "$1" == "enable" ]; then

	if [ ! -f $ROOT/$NAME/.$NAME ]; then
		
			if [ ! -f $ROOT/$NAME/$NAME ]; then
			
				echo "Service $NAME does not exist"
				exit 1
			fi
			echo "Service $NAME is not disabled"
			exit 1
		fi
	mv $ROOT/$NAME/.$NAME $ROOT/$NAME/$NAME

	if [ "$2" == "--now" ]; then
		service start $NAME
	fi

elif [ "$1" == "list" ]; then
	if [ "$2" == "--all" ]; then
	
		(cd $ROOT && for d in */; do echo ${d::-1}; done)
		
	elif [ "$2" == "--enabled" ]; then
		(cd $ROOT
			for d in */; do
				if [ -f "$d${d::-1}" ]; then
					echo ${d::-1}
				fi
			done)
	elif [ "$2" == "--running" ]; then
		for d in /tmp/*.log; do
		
			d=$(echo ${d##/tmp/})
			d=$(echo ${d%%.log})

			if [ -d $ROOT/$d ]; then
				echo $d
			fi
		done
	fi

fi
